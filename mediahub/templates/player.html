{% load static %}

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Video Player</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'mediahub.css' %}">
  <link rel="stylesheet" href="{% static 'css/video-js.css' %}">

  {% include "_favicon.html" %}

</head>
<body>

  {% include "_navbar.html" %}

  {% include "_toast.html" %}

<div id="main-frame" style="background-image: url('{{ backdrop_url }}');">
  <!--<button type="button" class="btn btn-outline-info mt-2" id="set-poster-btn">Set Poster</button>-->

    <div class="video-container">
      <video 
        controls
        poster="{{ backdrop_url }}"
        id="video-player" 
        data-setup='{"fluid": true}'
        preload="none"
        class="video-js"
      >
        <source src="/media/stream/?path={{ file_path }}" type="video/mp4">
      </video>
    </div>

    <div class="movie-other card text-light mt-3 mb-3 shadow-sm border-0 rounded-3">

      <div class="card-body">
        <span class="card-title h5 mb-2 me-2">
          {{ item.title }}
          {% if item.year %}
            , {{ item.year }}
          {% endif %}
        </span>
        
        {% for g in item.genre%}
          <span class="badge rounded-pill text-bg-info">{{ g }}</span>
        {% endfor %}
        

        {% if item.description %}
          <p class="card-text pt-2">
            {{ item.description }}
          </p>
        {% endif %}
      </div>
    </div>
     
  
  </div>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/video.min.js' %}"></script>
<script src="{% static 'mediahub.js' %}"></script>

<script>
  let player = null;

  const itemId = "{{ item_id }}";
  const csrftoken = "{{ csrf_token }}";
  const progress = "{{ progress }}"

  document.addEventListener("DOMContentLoaded", function() {
    const backBtn = document.getElementById("back-btn");
    backBtn.addEventListener("click", function() {  
      window.location.href = "/library/{{ lib_slug }}";
    });

        
    player = videojs('video-player', {
      userActions: {
        hotkeys: {},
      }
    });

    if(progress != 0) {
      player.currentTime(progress);
    } 

  });

  document.getElementById("set-poster-btn")?.addEventListener("click", function(e) {
    e.preventDefault();

    const video = document.getElementById("video-player");
    const currentTime = Math.floor(player.currentTime());  // in seconds

    fetch(`/set_poster/${itemId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ time: currentTime })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("Poster updated!")
      } else {
        showToast("Error: " + data.error, true);
      }
    });
  });

  // Every 15s, save current time
  setInterval(() => {
    const currentTime = Math.floor(player.currentTime());
    fetch(`/api/save_progress/${itemId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ time: currentTime })
    });
  }, 15000);

</script>

</body>
</html>
