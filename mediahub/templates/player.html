{% load static %}

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Video Player</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'mediahub.css' %}">
</head>
<body>

  {% include "_navbar.html" %}

<main>
  <video controls autoplay style="width:100%; max-height:90vh;" id="video-player">
    <source src="/media/stream/?path={{ file_path }}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <button type="button" class="btn btn-outline-info" id="set-poster-btn" data-id="{{ item_id }}">Set Poster</button>
</main>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      const backBtn = document.getElementById("back-btn");
      backBtn.addEventListener("click", function() {  
          window.location.href = "/library/{{ lib_slug }}";
      });
  });

  document.getElementById("set-poster-btn")?.addEventListener("click", function(e) {
    e.preventDefault();

    const video = document.getElementById("video-player");
    const currentTime = Math.floor(video.currentTime);  // in seconds
    const itemId = this.dataset.id;
    const csrftoken = document.querySelector('meta[name="csrf-token"]').content;

    fetch(`/set_poster/${itemId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ time: currentTime })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Poster updated!");
      } else {
        alert("Error: " + data.error);
      }
    });
  });

</script>

</body>
</html>
